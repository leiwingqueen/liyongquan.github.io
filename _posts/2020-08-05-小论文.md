---
layout: post
title:  直播营收-异步数据迁移实践
description: 直播营收-异步数据迁移实践
date:   2020-08-05 17:35:00 +000
categories: 论文
tags: 论文
---


## 摘要

2020年直播财务和审计沟通之后决定把【星豆兑换星币】功能获得的星币也纳入到营收的范畴，这个改动相当于对我们原有的账户体系做一个比较大的改动。星币账户=充值账户+赠送账户 修改为 星币账户=充值账户+赠送账户+赠送账户。另外用户消费的扣费、冻结、解冻等账户之间的扣减顺序也需要做出变动，另外在上线的时候无法灰度。于是前期我们选择使用旁路计算的方式计算兑换账户的流水和余额，后期再对用户的兑换余额做迁移。

图1.账户体系

为了简化和统一后续说明，我们统一把星币账户、充值账户、兑换账户、赠送账户分别定义为coin,money,exchange,virtual

图2.整体方案



## 一、需求背景

同上

## 二、问题&难点



### 1.旁路计算

- 计算规则复杂

用户流水计算

| 场景                 | 计算规则                                | 备注     |
| -------------------- | --------------------------------------- | -------- |
| 星豆兑换星币         | 80%星币算入exchange，20%星币算入virtual |          |
| 扣费/冻结/管理员调整 | money>exchange>virtual                  | 扣费顺序 |
| 退款/解冻原路退回    | virtual>exchange>money                  | 退款顺序 |
| 其他                 | exchange=0                              |          |

消费流水分摊规则

由于历史的原因，一笔扣费的流水可能会产生多笔消费流水(分摊给多个不同的主播)。这时候我们需要对exchange进行分摊操作。核心的逻辑是按照每笔消费订单分摊到的coin，根据订单的顺序，依次尝试从money、exchange的池中获取相应的money和exchange进行分摊。在每个用户分摊的过程中同样遵循money>exchange>virtual的顺序，下面举个例子说明。

coin=1000,money=500,exchange=300。我们尝试分摊到3笔消费流水

| 消费流水 | coin | money | exchange | virtual |
| -------- | ---- | ----- | -------- | ------- |
| A        | 100  | 200   | 0        | 0       |
| B        | 500  | 300   | 200      | 0       |
| C        | 400  | 0     | 100      | 300     |

这里尝试介绍一些比较核心的场景，实际的场景会比描述的复杂一些

- 对流水时序性严格要求
- 需要支持按指定位点重跑

### 2.数据迁移



## 三、业界解决方案对比

flink



## 四、整体设计

### 4.1 设计目标

### 4.2 实现方法及效果

### 4.3 ...

### 4.4 总结